sap.ui.define(["sap/m/MessageToast","sap/ui/core/mvc/Controller","sap/ui/model/Filter","sap/ui/model/FilterOperator","sap/ui/model/FilterType","sap/ui/model/Sorter","sap/ui/core/util/Export","sap/ui/core/util/ExportTypeCSV","sap/m/MessageBox","sap/ui/core/util/MockServer","sap/ui/export/Spreadsheet","sap/ui/model/odata/v2/ODataModel","sap/ui/model/json/JSONModel","sap/ui/core/util/Export","sap/ui/core/util/ExportTypeCSV"],function(e,t,a,o,n,s,r,i,l,_,d,M,p,u,O){"use strict";var c={BotList:[]};return t.extend("MM.mat_consumption.controller.Home",{onInit:function(){var e=this},_getMatStock:function(e,t,a){var o=this.getView().byId("idFieldPlant").getValue().toUpperCase();var n=this.getOwnerComponent().getModel("MATSTOCK");var s={MatStock:[]};var r=new sap.ui.model.Filter("Plant",sap.ui.model.FilterOperator.EQ,o);var i=new sap.ui.model.Filter({filters:[r],and:true});var l=new Array(new sap.ui.model.Filter({filters:[i],and:true}));n.read("/YY1_MatStock",{urlParameters:{$select:"Material, Plant, CreationDate, MatlCnsmpnQtyInMatlBaseUnit, MaterialBaseUnit, ProductDescription, CrossPlantStatus, On_Hand_Qty"},filters:[l],success:function(e,a){var o=e.results;o.sort();var n=o.length;if(n!==0){sap.m.MessageToast.show("Getting Material stock!!! ");for(var r=0;r<n;r++){if(o[r].Material!==""&&o[r].Plant!==""){s.MatStock.push({Material:o[r].Material,Plant:o[r].Plant,CreationDate:o[r].CreationDate,MaterialBaseUnit:o[r].MaterialBaseUnit,MatlCnsmpnQtyInMatlBaseUnit:o[r].MatlCnsmpnQtyInMatlBaseUnit,On_Hand_Qty:o[r].On_Hand_Qty,SLoc_S099_Qty:o[r].on_hnd_s099,ProductDescription:o[r].ProductDescription,CrossPlantStatus:o[r].CrossPlantStatus})}}}t(s.MatStock)},error:function(){a()}})},_getStd_Price:function(e,t,a){var o=this.getView().byId("idFieldPlant").getValue().toUpperCase();var n=this.getOwnerComponent().getModel("STDPRICE");var s={StdPrice:[]};var r=new sap.ui.model.Filter("ValuationArea",sap.ui.model.FilterOperator.EQ,o);var i=new sap.ui.model.Filter({filters:[r],and:true});var l=new Array(new sap.ui.model.Filter({filters:[i],and:true}));n.read("/YY1_Prod_Std_Price",{urlParameters:{$select:"Product, ValuationArea, Std_Price"},filters:[l],success:function(e,a){var o=e.results;o.sort();var n=o.length;if(n!==0){sap.m.MessageToast.show("Getting standard price!!! ");for(var r=0;r<n;r++){if(o[r].Material!==""&&o[r].ValuationArea!==""){s.StdPrice.push({Material:o[r].Product,Std_Price:o[r].Std_Price,ValuationArea:o[r].ValuationArea})}}}t(s.StdPrice)},error:function(){a()}})},_getGoods_Mvnt:function(e,t,a){var o=this.getView().byId("idFieldPlant").getValue().toUpperCase();var n=this.getOwnerComponent().getModel("GOODSMVNT");var s={GOODS_MVMT:[]};var r=new sap.ui.model.Filter("Plant",sap.ui.model.FilterOperator.EQ,o);var i=new sap.ui.model.Filter({filters:[r],and:true});var l=this.getView().byId("idDatePicker").getValue().toUpperCase();var _=l.slice(6,10);var d=l.slice(0,2);var M=l.slice(3,5);var l=_+"-"+d+"-"+M;var p=new Date(l);var _=_-2;var u=_+"-"+d+"-"+M;var u=new Date(u);var O=new sap.ui.model.Filter("DocumentDate",sap.ui.model.FilterOperator.LE,p.toISOString());var c=new sap.ui.model.Filter({filters:[O],and:true});var m=new sap.ui.model.Filter("DocumentDate",sap.ui.model.FilterOperator.GE,u.toISOString());var S=new sap.ui.model.Filter({filters:[m],and:true});var v=new Array(new sap.ui.model.Filter({filters:[i,c,S],and:true}));n.read("/YY1_GOODS_MVMT",{urlParameters:{$select:"Material, Plant, MaterialBaseUnit, DocumentDate, TotalGdsMvtQtyInBaseUnit, CreationDate, GoodsMovementType"},filters:[v],success:function(e,a){var o=e.results;o.sort();var n=o.length;if(n!==0){sap.m.MessageToast.show("Getting goods movement data!!! ");for(var r=0;r<n;r++){if(o[r].Material!==""&&o[r].Plant!==""&&(o[r].GoodsMovementType==="201"||o[r].GoodsMovementType==="202"||o[r].GoodsMovementType==="602"||o[r].GoodsMovementType==="601")){s.GOODS_MVMT.push({Material:o[r].Material,Plant:o[r].Plant,MaterialBaseUnit:o[r].MaterialBaseUnit,DocumentDate:o[r].DocumentDate,TotalGdsMvtQtyInBaseUnit:o[r].TotalGdsMvtQtyInBaseUnit,CreationDate:o[r].CreationDate,GoodsMovementType:o[r].GoodsMovementType})}}}t(s.GOODS_MVMT)},error:function(){a()}})},_getGoods_MvntQty:function(e,t,a){var o=this.getOwnerComponent().getModel("GOODSMVNT");var n={Goods_MvntQty:[]};var s=this.getView().byId("idFieldPlant").getValue().toUpperCase();var r=new sap.ui.model.Filter("Plant",sap.ui.model.FilterOperator.EQ,s);var i=new sap.ui.model.Filter({filters:[r],and:true});var l=this.getView().byId("idDatePicker").getValue().toUpperCase();var _=l.slice(6,10);var d=l.slice(0,2);var M=l.slice(3,5);var l=_+"-"+d+"-"+M;var p=new Date(l);var _=_-2;var u=_+"-"+d+"-"+M;var u=new Date(u);var O=new sap.ui.model.Filter("DocumentDate",sap.ui.model.FilterOperator.LE,p.toISOString());var c=new sap.ui.model.Filter({filters:[O],and:true});var m=new sap.ui.model.Filter("DocumentDate",sap.ui.model.FilterOperator.GE,u.toISOString());var S=new sap.ui.model.Filter({filters:[m],and:true});var v=new Array(new sap.ui.model.Filter({filters:[i,c,S],and:true}));o.read("/YY1_GOODS_MVMT",{urlParameters:{$select:"Material, Plant, TotalGdsMvtQtyInBaseUnit, CreationDate, GoodsMovementType"},filters:[v],success:function(e,a){var o=e.results;o.sort();var s=o.length;if(s!==0){sap.m.MessageToast.show("Getting goods movement data!!! ");for(var r=0;r<s;r++){if(o[r].Material!==""&&o[r].Plant!==""&&(o[r].GoodsMovementType==="201"||o[r].GoodsMovementType==="202"||o[r].GoodsMovementType==="602"||o[r].GoodsMovementType==="601")){n.Goods_MvntQty.push({Material:o[r].Material,Plant:o[r].Plant,TotalGdsMvtQtyInBaseUnit:o[r].TotalGdsMvtQtyInBaseUnit,CreationDate:o[r].CreationDate,GoodsMovementType:o[r].GoodsMovementType})}}}t(n.Goods_MvntQty)},error:function(){a()}})},_getSL099_QUANTITY:function(e,t,a){var o=this.getOwnerComponent().getModel("MATSTOCK");var n={SL099_QUANTITY:[]};var s=this.getView().byId("idFieldPlant").getValue().toUpperCase();var r=new sap.ui.model.Filter("Plant",sap.ui.model.FilterOperator.EQ,s);var i=new sap.ui.model.Filter({filters:[r],and:true});var l="S099";var _=new sap.ui.model.Filter("StorageLocation",sap.ui.model.FilterOperator.EQ,l);var d=new sap.ui.model.Filter({filters:[_],and:true});var M=new Array(new sap.ui.model.Filter({filters:[i,d],and:true}));o.read("/YY1_MatStock",{urlParameters:{$select:"Material, Plant, StorageLocation, On_Hand_Qty"},filters:[M],success:function(e,a){var o=e.results;o.sort();var s=o.length;if(s!==0){sap.m.MessageToast.show("Getting goods movement data!!! ");for(var r=0;r<s;r++){if(o[r].Material!==""&&o[r].Plant!==""){n.SL099_QUANTITY.push({Material:o[r].Material,Plant:o[r].Plant,On_Hand_Qty:o[r].On_Hand_Qty})}}}t(n.SL099_QUANTITY)},error:function(){a()}})},_buildFinalData:function(e){var t=0;var a={};var o=[];var n=0;var s=e;for(var r=0;r<s.StdPrice.length;r++){for(var i=0;i<s.MatStock.length;i++){if(s.MatStock[i].Material===s.StdPrice[r].Material&&s.MatStock[i].Plant===s.StdPrice[r].ValuationArea){for(var l=0;l<s.SL099_QUANTITY.length;l++){if(s.MatStock[i].Material===s.SL099_QUANTITY[l].Material){a.SLoc_S099_Qty=parseFloat(s.SL099_QUANTITY[l].On_Hand_Qty);break}}var _=this.getView().byId("idDatePicker").getValue().toUpperCase();var d=this.getView().byId("idDatePicker").getValue().toUpperCase();var M=d.slice(6,10);var p=d.slice(0,2);var u=M;var O=p;O=parseFloat(O);var m=s.MatStock[i].CreationDate.getFullYear();var S=s.MatStock[i].CreationDate.getMonth();t=(u-m)*12+(O-S);a.Material=s.MatStock[i].Material;a.ProductDescription=s.MatStock[i].ProductDescription;a.Plant=s.MatStock[i].Plant;a.CrossPlantStatus=s.MatStock[i].CrossPlantStatus;a.On_Hand_Qty=parseFloat(n)+parseFloat(s.MatStock[i].On_Hand_Qty);a.Tot_Std_Cost=parseFloat(s.MatStock[i].On_Hand_Qty)*parseFloat(s.StdPrice[r].Std_Price);a.Tot_Std_Cost=parseFloat(a.Tot_Std_Cost).toFixed(2);a.Std_Price=parseFloat(s.StdPrice[r].Std_Price).toFixed(2);a.CreationDate=s.MatStock[i].CreationDate.toISOString().slice(0,10);var M=a.CreationDate.slice(0,4);var p=a.CreationDate.slice(5,7);var v=a.CreationDate.slice(8,10);a.CreationDate=p+"/"+v+"/"+M;a.Consumption=0;a.Consumption201=0;a.Consumption202=0;a.GoodsShipped=0;a.GoodsShipped601=0;a.GoodsShipped602=0;a.ExcessQOH="0";for(var C=0;C<s.GOODS_MVMT_CUM.length;C++){if(s.MatStock[i].Material===s.GOODS_MVMT_CUM[C].Material&&s.MatStock[i].Plant===s.GOODS_MVMT_CUM[C].Plant){a.GoodsShipped=0;a.GoodsShipped601=0;a.GoodsShipped602=0;if((s.GOODS_MVMT_CUM[C].Plant==="US01"||s.GOODS_MVMT_CUM[C].Plant==="US02"||s.GOODS_MVMT_CUM[C].Plant==="US03")&&s.GOODS_MVMT_CUM[C].GoodsMovementType==="601"||s.GOODS_MVMT_CUM[C].GoodsMovementType==="602"){for(var f=0;f<s.GOODS_MVMT_CUM.length;f++){if(s.GOODS_MVMT_CUM[f].Material===s.GOODS_MVMT_CUM[C].Material&&s.GOODS_MVMT_CUM[f].Plant===s.GOODS_MVMT_CUM[C].Plant&&s.GOODS_MVMT_CUM[f].GoodsMovementType==="601"){a.GoodsShipped601=parseFloat(s.GOODS_MVMT_CUM[f].TotalGdsMvtQtyInBaseUnit)}if(s.GOODS_MVMT_CUM[f].Material===s.GOODS_MVMT_CUM[C].Material&&s.GOODS_MVMT_CUM[f].Plant===s.GOODS_MVMT_CUM[C].Plant&&s.GOODS_MVMT_CUM[f].GoodsMovementType==="602"){a.GoodsShipped602=parseFloat(s.GOODS_MVMT_CUM[f].TotalGdsMvtQtyInBaseUnit)}}}a.Consumption=0;a.Consumption201=0;a.Consumption202=0;if((s.GOODS_MVMT_CUM[C].Plant==="US01"||s.GOODS_MVMT_CUM[C].Plant==="US02"||s.GOODS_MVMT_CUM[C].Plant==="US03")&&s.GOODS_MVMT_CUM[C].GoodsMovementType==="201"||s.GOODS_MVMT_CUM[C].GoodsMovementType==="202"){for(var f=0;f<s.GOODS_MVMT_CUM.length;f++){if(s.GOODS_MVMT_CUM[f].Material===s.GOODS_MVMT_CUM[C].Material&&s.GOODS_MVMT_CUM[f].Plant===s.GOODS_MVMT_CUM[C].Plant&&s.GOODS_MVMT_CUM[f].GoodsMovementType==="201"){a.Consumption201=parseFloat(s.GOODS_MVMT_CUM[f].TotalGdsMvtQtyInBaseUnit)}if(s.GOODS_MVMT_CUM[f].Material===s.GOODS_MVMT_CUM[C].Material&&s.GOODS_MVMT_CUM[f].Plant===s.GOODS_MVMT_CUM[C].Plant&&s.GOODS_MVMT_CUM[f].GoodsMovementType==="202"){a.Consumption202=parseFloat(s.GOODS_MVMT_CUM[f].TotalGdsMvtQtyInBaseUnit)}}}if(t<=24){a.MonthUsage24=parseFloat(a.Consumption)+parseFloat(a.GoodsShipped);a.MonthUsage24=parseFloat(a.MonthUsage24)/parseFloat(t)*24;a.MonthUsage24=parseFloat(a.MonthUsage24).toFixed(2)}else{a.MonthUsage24=parseFloat(a.Consumption)+parseFloat(a.GoodsShipped)}}}if(a.GoodsShipped601==="undefined"){a.GoodsShipped601=0}if(a.GoodsShipped602==="undefined"){a.GoodsShipped602=0}if(a.Consumption201==="undefined"){a.Consumption201=0}if(a.Consumption202==="undefined"){a.Consumption202=0}a.Consumption=parseFloat(a.Consumption201)+parseFloat(a.Consumption202);a.GoodsShipped=parseFloat(a.GoodsShipped601)+parseFloat(a.GoodsShipped602);if(a.CrossPlantStatus==="05"){a.ExcessQOH=a.On_Hand_Qty}if(a.CrossPlantStatus==="03"){var h=parseFloat(a.MonthUsage24)-parseFloat(a.On_Hand_Qty);if(h>0){a.ExcessQOH=h}else{a.ExcessQOH="0"}}var _=this.getView().byId("idDatePicker").getValue().toUpperCase();var M=_.slice(6,10);var p=_.slice(0,2);var u=M;var O=p;O=parseFloat(O);var m=s.MatStock[i].CreationDate.getFullYear();var S=s.MatStock[i].CreationDate.getMonth();t=(u-m)*12+(O-S);if(t<=24){a.Months_Usage_Life_in_months=t}else{a.Months_Usage_Life_in_months="0"}if(a.CrossPlantStatus==="05"||a.MonthUsage24==="0"){a.NEW_OBS_EXC_or_GOOD="OBS"}if(a.ExcessQOH==="0"){a.NEW_OBS_EXC_or_GOOD="GOOD"}if((a.CrossPlantStatus==="02"||a.CrossPlantStatus==="03"||a.CrossPlantStatus==="04")&&a.ExcessQOH>"0"){a.NEW_OBS_EXC_or_GOOD="EXC"}if(t<"12"){a.NEW_OBS_EXC_or_GOOD="NEW"}if(a.NEW_OBS_EXC_or_GOOD==="EXC"){a.Excess_OH_FIFO=a.ExcessQOH*a.Std_Price}else{a.Excess_OH_FIFO="0"}if(a.NEW_OBS_EXC_or_GOOD==="OBS"){a.Obsolete_OH_FIFO=a.ExcessQOH*a.Std_Price}else{a.Obsolete_OH_FIFO="0"}a.E_O_OH_FIFO=a.Excess_OH_FIFO+a.Obsolete_OH_FIFO;if(a.E_O_OH_FIFO==="undefined"||a.E_O_OH_FIFO===""){a.E_O_OH_FIFO="0"}if(a.Tot_Std_Cost==="undefined"||a.Tot_Std_Cost===""){a.Tot_Std_Cost="0"}if(a.Std_Price==="undefined"||a.Std_Price===""){a.Std_Price="0"}if(a.GoodsShipped==="undefined"||a.GoodsShipped===""){a.GoodsShipped="0"}if(a.Consumption==="undefined"||a.Consumption===""){a.Consumption="0"}if(a.MonthUsage24==="undefined"||a.MonthUsage24===""){a.MonthUsage24="0"}if(a.Months_Usage_Life_in_months==="undefined"||a.Months_Usage_Life_in_months===""){a.Months_Usage_Life_in_months="0"}if(a.ExcessQOH==="undefined"||a.ExcessQOH===""){a.ExcessQOH="0"}if(a.NEW_OBS_EXC_or_GOOD==="undefined"||a.NEW_OBS_EXC_or_GOOD===""){a.NEW_OBS_EXC_or_GOOD="0"}if(a.Excess_OH_FIFO==="undefined"||a.Excess_OH_FIFO===""){a.Excess_OH_FIFO="0"}if(a.Obsolete_OH_FIFO==="undefined"||a.Obsolete_OH_FIFO===""){a.Obsolete_OH_FIFO="0"}o.push(a);a={}}}}c.BotList=o;var G=[];var T={};T.columnName="Material";G.push(T);T={};T.columnName="ProductDescription";G.push(T);T={};T.columnName="Plant";G.push(T);T={};T.columnName="CrossPlantStatus";G.push(T);T={};T.columnName="On_Hand_Qty";G.push(T);T={};T.columnName="Tot_Std_Cost";G.push(T);T={};T.columnName="Std_Price";G.push(T);T={};T.columnName="GoodsShipped";G.push(T);T={};T.columnName="Consumption";G.push(T);T={};T.columnName="SLoc_S099_Qty";G.push(T);T={};T.columnName="MonthUsage24";G.push(T);T={};T.columnName="ExcessQOH";G.push(T);T={};T.columnName="NEW_OBS_EXC_or_GOOD";G.push(T);T={};T.columnName="Excess_OH_FIFO";G.push(T);T={};T.columnName="Obsolete_OH_FIFO";G.push(T);T={};T.columnName="E_O_OH_FIFO";G.push(T);T={};T.columnName="Months_Usage_Life_in_months";G.push(T);T={};T.columnName="CreationDate";G.push(T);T={};var F=sap.ui.getCore().byId("container-mat_consumption---Home--idTable");var D=new sap.ui.model.json.JSONModel;D.setData({rows:o,columns:G,width:"11rem"});F.setModel(D);F.bindColumns("/columns",function(e,t){var a=t.getObject().columnName;return new sap.ui.table.Column({label:a,template:a})});F.bindRows("/rows")},onSearch:function(){var e=this;var t=this.getView().byId("idFieldPlant").getValue().toUpperCase();var a=this.getView().byId("idDatePicker").getValue().toUpperCase();if(t===""){sap.m.MessageToast.show("Please provide Plant value!!! ")}if(a===""){sap.m.MessageToast.show("Please provide End Date value!!! ")}if(t!==""&&a!==""){sap.ui.core.BusyIndicator.show();var o={items:[],Material:[],MatStock:[],StdPrice:[],GOODS_MVMT:[],GOODS_MVMT_CUM:[],Goods_MvntQty:[],SL099_QUANTITY:[]};var t=this.getView().byId("idFieldPlant").getValue().toUpperCase();var a=this.getView().byId("idDatePicker").getValue().toUpperCase();var n=this.getView().byId("idDatePicker").getValue().toUpperCase();var s=n.slice(6,10);var r=n.slice(0,2);var i=n.slice(3,5);var a=s+"-"+r+"-"+i;var l;var _;var d;var _;var M;var p=new Promise(function(a,o){e._getMatStock(t,a,o)});p.then(function(a){o.MatStock=a;l=new Promise(function(a,o){e._getStd_Price(t,a,o)});l.then(function(a){o.StdPrice=a;_=new Promise(function(a,o){e._getSL099_QUANTITY(t,a,o)});_.then(function(a){d=new Promise(function(n,s){o.SL099_QUANTITY=a;e._getGoods_Mvnt(t,n,s)});d.then(function(a){M=new Promise(function(n,s){o.GOODS_MVMT=a;e._getGoods_MvntQty(t,n,s)});M.then(function(t){o.GOODS_MVMT_CUM=t;e._buildFinalData(o);sap.ui.core.BusyIndicator.hide()},function(){})},function(){})},function(){},function(){})},function(){})},function(){})}},onDataExport:function(e){var t=new sap.ui.model.json.JSONModel;t.setData(c.BotList);var a=new u({exportType:new sap.ui.core.util.ExportTypeCSV({separatorChar:",",charset:"utf-8"}),models:t,rows:{path:"/"},columns:[{name:"Material",template:{content:"'{Material}"}},{name:"Product Description",template:{content:"{ProductDescription}"}},{name:"Plant",template:{content:"{Plant}"}},{name:"Cross Plant Status",template:{content:"'{CrossPlantStatus}"}},{name:"On Hand Qty",template:{content:"{On_Hand_Qty}"}},{name:"Total Std Cost",template:{content:"{Tot_Std_Cost}"}},{name:"Std Price",template:{content:"{Std_Price}"}},{name:"Goods Shipped",template:{content:"{GoodsShipped}"}},{name:"Consumption",template:{content:"{Consumption}"}},{name:"S.Loc S099 Qty",template:{content:"{SLoc_S099_Qty}"}},{name:"24 Month Usage",template:{content:"{MonthUsage24}"}},{name:"Excess QOH",template:{content:"{ExcessQOH}"}},{name:"NEW, OBS, EXC or GOOD",template:{content:"{NEW_OBS_EXC_or_GOOD}"}},{name:"Excess OH FIFO",template:{content:"{Excess_OH_FIFO}"}},{name:"Obsolete OH FIFO",template:{content:"{Obsolete_OH_FIFO}"}},{name:"E_O_OH_FIFO",template:{content:"{E_O_OH_FIFO}"}},{name:"Months Usage Life in months",template:{content:"{Months_Usage_Life_in_months}"}},{name:"Creation Date",template:{content:"{CreationDate}"}}]});a.saveFile().always(function(){this.destroy()})}})});